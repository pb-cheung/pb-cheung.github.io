(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{445:function(t,a,s){t.exports=s.p+"assets/img/V8-memory-structure.51d59467.png"},446:function(t,a){t.exports="data:image/png;base64,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"},447:function(t,a){t.exports="data:image/png;base64,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"},448:function(t,a,s){t.exports=s.p+"assets/img/minor-gc-1.4faa13bb.gif"},449:function(t,a,s){t.exports=s.p+"assets/img/minor-gc-2.35cf9a20.gif"},450:function(t,a,s){t.exports=s.p+"assets/img/mark-sweep-compact.648c9894.png"},451:function(t,a,s){t.exports=s.p+"assets/img/mark-sweep-compact.7bccbe1e.gif"},452:function(t,a,s){t.exports=s.p+"assets/img/major-gc-parallel.0cd12639.svg"},453:function(t,a,s){t.exports=s.p+"assets/img/nodejs-memory-max.01d7c8bd.png"},555:function(t,a,s){"use strict";s.r(a);var n=s(56),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,n=t._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"v8虚拟内存管理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#v8虚拟内存管理"}},[t._v("#")]),t._v(" V8虚拟内存管理")]),t._v(" "),n("h2",{attrs:{id:"_1-v8内存结构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-v8内存结构"}},[t._v("#")]),t._v(" 1.V8内存结构")]),t._v(" "),n("p",[n("img",{attrs:{src:s(445),alt:"memory structure"}})]),t._v(" "),n("h3",{attrs:{id:"heap-memory-堆内存"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#heap-memory-堆内存"}},[t._v("#")]),t._v(" Heap memory（堆内存）")]),t._v(" "),n("ul",[n("li",[t._v("用来存储对象（objects）和动态数据（dynamic data）。")]),t._v(" "),n("li",[t._v("堆内存中并不是所有空间都要进行垃圾回收")]),t._v(" "),n("li",[t._v("进行垃圾回收的只有New Space和Old space")])]),t._v(" "),n("h4",{attrs:{id:"new-space"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#new-space"}},[t._v("#")]),t._v(" New Space")]),t._v(" "),n("p",[t._v("新空间（新生代），存储新的对象，这些对象通常存活时间较短。")]),t._v(" "),n("p",[t._v("新空间被分为两个空间相等的子空间(semi spaces)："),n("code",[t._v("from-space")]),t._v("和"),n("code",[t._v("to-space")]),t._v("，它们二者是可以互相转换的。")]),t._v(" "),n("p",[n("code",[t._v("--min_semi_space_size")]),t._v(" "),n("code",[t._v("--max_semi_space_size")])]),t._v(" "),n("h4",{attrs:{id:"old-space"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#old-space"}},[t._v("#")]),t._v(" Old Space")]),t._v(" "),n("p",[t._v("旧空间（老年代），存储存活时间较长的对象，新空间中经过两次minor GC的对象就会被放到旧空间来。")]),t._v(" "),n("p",[n("code",[t._v("--initial_old_space_size")]),t._v(" "),n("code",[t._v("--max_old_space_size")])]),t._v(" "),n("h4",{attrs:{id:"larget-object-space"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#larget-object-space"}},[t._v("#")]),t._v(" Larget Object space")]),t._v(" "),n("p",[t._v("大型对象空间。存储其他内存空间都装不下的大型对象，不会被GC清理。")]),t._v(" "),n("h4",{attrs:{id:"code-space"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#code-space"}},[t._v("#")]),t._v(" Code space")]),t._v(" "),n("p",[t._v("存储及时编译器（JIT）编译过的代码块。有可执行内存的空间。")]),t._v(" "),n("h4",{attrs:{id:"cell-space、property-cell-space、map-space"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#cell-space、property-cell-space、map-space"}},[t._v("#")]),t._v(" Cell space、Property cell space、Map space")]),t._v(" "),n("p",[t._v("这些该空间包含的对象的大小都一致，简化了gc。")]),t._v(" "),n("h3",{attrs:{id:"stack-memory-栈内存"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#stack-memory-栈内存"}},[t._v("#")]),t._v(" Stack memory（栈内存）")]),t._v(" "),n("ul",[n("li",[t._v("V8每个进程分配一个栈内存空间")]),t._v(" "),n("li",[t._v("栈存储静态数据：\n"),n("ul",[n("li",[t._v("方法函数帧（frame）")]),t._v(" "),n("li",[t._v("字面量（primitive values）")]),t._v(" "),n("li",[t._v("对象的引用")])])]),t._v(" "),n("li",[t._v("操作系统管理")])]),t._v(" "),n("h2",{attrs:{id:"_2-garbage-collection-垃圾回收"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-garbage-collection-垃圾回收"}},[t._v("#")]),t._v(" 2.Garbage Collection（垃圾回收）")]),t._v(" "),n("p",[t._v("栈内存由系统管理，无需V8引擎来处理。")]),t._v(" "),n("p",[t._v("堆内存占据了大量的内存空间，且存储着动态数据。如果不加以管理，它可能会指数级增长耗尽内存，或者在一段时间后碎片化拖慢我们的应用。")]),t._v(" "),n("p",[t._v("释放"),n("code",[t._v("孤儿对象")]),t._v("(orphan object)占据内存，然后重新分配给进程使用。")]),t._v(" "),n("blockquote",[n("p",[t._v("孤儿对象：1. 没有被栈中的元素所引用； 2. 没有被堆中的另一个对象引用")])]),t._v(" "),n("p",[t._v("清理前：")]),t._v(" "),n("p",[n("img",{attrs:{src:s(446),alt:"before-gc"}})]),t._v(" "),n("p",[t._v("清理后：")]),t._v(" "),n("p",[n("img",{attrs:{src:s(447),alt:"after-gc"}})]),t._v(" "),n("h3",{attrs:{id:"垃圾回收"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#垃圾回收"}},[t._v("#")]),t._v(" 垃圾回收")]),t._v(" "),n("p",[t._v("两个阶段（stage）三种算法")]),t._v(" "),n("h3",{attrs:{id:"minor-gc"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#minor-gc"}},[t._v("#")]),t._v(" Minor GC")]),t._v(" "),n("ul",[n("li",[t._v("发生在新空间（new space）")]),t._v(" "),n("li",[t._v("触发时机，内存分配指针到到达新空间边界")]),t._v(" "),n("li",[t._v("会阻塞程序运行，但是非常快和高效，使用并行的辅助线程，")])]),t._v(" "),n("p",[n("strong",[t._v("清道夫算法"),n("code",[t._v("scanvenger")])])]),t._v(" "),n("p",[t._v("scanvenger [ˈskævɪndʒə(r)]，用到的算法是"),n("code",[t._v("Cheney")])]),t._v(" "),n("p",[t._v("Minor GC 具体过程：")]),t._v(" "),n("ol",[n("li",[t._v("from-space中01-06块已经被分配占用")]),t._v(" "),n("li",[t._v("现在进程需要创建一个新的内存块07来使用")]),t._v(" "),n("li",[t._v("发现From-space中内存空间不够，这样就触发了 minor GC")]),t._v(" "),n("li",[t._v("minor GC 通过栈中的指针（GC Root）递归遍历对象树，找出仍在使用的对象，将它们移动到to-space，它们引用的对象也一并被移动过去。与此同时，因为在新的空间挨个排列，也完成了"),n("code",[t._v("压缩")]),t._v("减少了碎片。")]),t._v(" "),n("li",[t._v("重复4.的过程，直到遍历完from-space中所有的对象")]),t._v(" "),n("li",[t._v("清空From-space（剩余的未被引用的objects就是被清理的垃圾），垃圾清理完成，from-space和to-space角色发生互换")])]),t._v(" "),n("p",[n("img",{attrs:{src:s(448),alt:"minor gc 1"}})]),t._v(" "),n("ol",{attrs:{start:"7"}},[n("li",[t._v("进程创建object10，空间不够，重复1.-6.过程")])]),t._v(" "),n("p",[n("img",{attrs:{src:s(449),alt:"minor gc 2"}})]),t._v(" "),n("h3",{attrs:{id:"major-gc"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#major-gc"}},[t._v("#")]),t._v(" Major GC")]),t._v(" "),n("ul",[n("li",[t._v("作用域old space")]),t._v(" "),n("li",[t._v("进行清理和压缩")]),t._v(" "),n("li",[t._v("触发时机，V8引擎认为没有足够的old space（随着minor GC动态计算容量）")])]),t._v(" "),n("p",[t._v("使用算法："),n("code",[t._v("Mark-Sweep")]),t._v("(标记清除)和"),n("code",[t._v("Mark-Compact")]),t._v("（标记整理）")]),t._v(" "),n("p",[n("strong",[t._v("Mark-Seep算法")]),t._v("：1.从GC Root递归深度优先遍历标记存活的对象，2.gc清理未被上一步标记存活的对象")]),t._v(" "),n("p",[n("strong",[t._v("Mark-compact算法")]),t._v("：前两步和标记-清除算法一样，多了第3.步压缩整理，所有存活的对象被移动放置在一起，来减少碎片。")]),t._v(" "),n("p",[t._v("算法说明：")]),t._v(" "),n("p",[n("img",{attrs:{src:s(450),alt:"标记-清除-压缩算法"}})]),t._v(" "),n("h4",{attrs:{id:"major-gc过程示例"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#major-gc过程示例"}},[t._v("#")]),t._v(" major gc过程示例：")]),t._v(" "),n("p",[n("img",{attrs:{src:s(451),alt:"mark-sweep-compact"}})]),t._v(" "),n("h4",{attrs:{id:"为什么不能使用minor-gc阶段的scavenger算法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#为什么不能使用minor-gc阶段的scavenger算法"}},[t._v("#")]),t._v(" 为什么不能使用minor GC阶段的Scavenger算法：")]),t._v(" "),n("ol",[n("li",[t._v("新空间存活对象少，Scanvenger算法适合，以空间换时间")]),t._v(" "),n("li",[t._v("旧空间存活对象多，存活时间长，如果使用Scanvernger算法则复制存活对象效率低（要复制大部分），而且要浪费一半的空间。")])]),t._v(" "),n("h4",{attrs:{id:"并行辅助线程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#并行辅助线程"}},[t._v("#")]),t._v(" 并行辅助线程")]),t._v(" "),n("p",[n("img",{attrs:{src:s(452),alt:"parallel"}})]),t._v(" "),n("p",[t._v("过程解释：")]),t._v(" "),n("ol",[n("li",[t._v("完成两个minor gc循环依然存活的对象，被移动到old space，old space没有足够的空间，启动major gc")]),t._v(" "),n("li",[t._v("多个和主线程并行的辅助线程进行标记操作")]),t._v(" "),n("li",[t._v("标记完成或者达到内存空间限制，主线程停止原有任务，做标记完成操作然后协调帮助线程清理和压缩、更新（指针）操作")])]),t._v(" "),n("p",[t._v("malloc = memory allocation [ˌæləˈkeɪʃn]")]),t._v(" "),n("h2",{attrs:{id:"_3-内存限制"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-内存限制"}},[t._v("#")]),t._v(" 3.内存限制")]),t._v(" "),n("h3",{attrs:{id:"获取内存基础信息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#获取内存基础信息"}},[t._v("#")]),t._v(" 获取内存基础信息")]),t._v(" "),n("p",[t._v("通过"),n("code",[t._v("process.memoryUsage")]),t._v("方法")]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[t._v("process"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("memoryUsage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 输出内容，单位为字节byte")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("rss")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("23068672")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Resident Set Size 驻留集大小（给进程分配的内存大小）")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("heapTotal")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4898816")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 堆大小")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("heapUsed")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("4035016")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 堆已使用空间")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("external")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("299796")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// V8管理的js对象关联的C++对象占用的内存。进程用到的系统链接库所占用的内存，如：“/usr/lib64/libstdc++.so.6.0.19”")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("arrayBuffers")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("11158")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ArrayBuffer 和 SharedArrayBuffer 相关的内存大小，属于 external 的一部分，属于堆外内存，不是V8分配")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h3",{attrs:{id:"最大内存"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#最大内存"}},[t._v("#")]),t._v(" 最大内存")]),t._v(" "),n("p",[t._v("默认最大内存：")]),t._v(" "),n("ul",[n("li",[t._v("32位系统中，1.5GB")]),t._v(" "),n("li",[t._v("64位系统中，4GB")])]),t._v(" "),n("blockquote",[n("p",[t._v("在 32 位系统中，由于内存地址的限制，一个进程最多只能使用 4GB 的虚拟内存空间，其中大约有 2GB 的空间用于操作系统和其他应用程序。因此，Node.js 默认的最大内存限制为 1.5GB。\n在 64 位系统中，由于内存地址的扩展，一个进程可以使用更大的虚拟内存空间，因此 Node.js 默认的最大内存限制为 4GB。")])]),t._v(" "),n("p",[n("strong",[t._v("修改方法")])]),t._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[t._v("node")]),t._v(" --max-old-space-size"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("8192")]),t._v(" server.js //单位为MB\n")])])]),n("p",[t._v("测试方法：")]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("format")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("bytes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("bytes "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("toFixed")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"MB"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("printMemoryUsage")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" memoryUsage "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" process"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("memoryUsage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("heapTotal: ")]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("format")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("memoryUsage"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("heapTotal"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v(", heapUsed: ")]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("format")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        memoryUsage"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("heapUsed\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" bigArray "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setInterval")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    bigArray"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("push")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Array")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("printMemoryUsage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("500")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("运行结果：\n"),n("img",{attrs:{src:s(453),alt:""}})]),t._v(" "),n("h2",{attrs:{id:"_4-内存泄露"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-内存泄露"}},[t._v("#")]),t._v(" 4.内存泄露")]),t._v(" "),n("p",[t._v("内存泄露从常见场景原因：")]),t._v(" "),n("p",[t._v("a. 全局变量\nb. 闭包引用\nc. 事件重复监听\nd. 缓存爆炸")]),t._v(" "),n("h3",{attrs:{id:"a-全局变量"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#a-全局变量"}},[t._v("#")]),t._v(" a.全局变量")]),t._v(" "),n("p",[t._v("未声明的变量（会直接绑定到全局对象Global或Window上）和全局变量下的变量，即使不再使用也不会被自动回收。")]),t._v(" "),n("p",[t._v("解决：delete或者赋值为null、undefined，改变之前的引用。")]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("test")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  x "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Array")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("test")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("x"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// [ <100000 empty items> ]")]),t._v("\n")])])]),n("h3",{attrs:{id:"b-闭包引用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#b-闭包引用"}},[t._v("#")]),t._v(" b.闭包引用")]),t._v(" "),n("blockquote",[n("p",[t._v("同一个作用域生成的闭包对象是被该作用域中所有下一级作用域共同持有的")])]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" theThing "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("replaceThing")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" originalThing "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" theThing\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("unused")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("originalThing"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hi"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  theThing "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("longStr")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Array")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'*'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("someMethod")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("someMessage"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setInterval")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("replaceThing"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("p",[t._v("例子来自：https://blog.meteor.com/an-interesting-kind-of-javascript-memory-leak-8b47d2e7f156")]),t._v(" "),n("p",[t._v("讨论：https://github.com/ElemeFE/node-interview/issues/7")]),t._v(" "),n("p",[t._v("解释：\nunused 使用了作用域的 originalThing 变量，因此 replaceThing 这一级的函数作用域中的闭包（someMethod）对象也持有了 originalThing 变量（重点：someMethod 的闭包作用域和 unused 的作用域是共享的），之间的引用关系就是 theThing 引用了 longStr 和 someMethod、someMethod 引用了 originalThing、originalThing 又引用了上次的 theThing，因此形成了链式引用。")]),t._v(" "),n("blockquote",[n("p",[t._v("在这个例子中，unused 函数确实是一个闭包，即使它没有被 replaceThing 函数返回。闭包指的是在一个函数内部定义的函数，这个内部函数引用了它外部函数的变量，并且这个内部函数的作用域链包括它外部函数的作用域。在这个例子中，unused 函数在 replaceThing 函数内部定义，它引用了 originalThing 变量，而 originalThing 变量又引用了 theThing 变量。因此，unused 函数可以访问 theThing 变量，并且它的作用域链中包括了 replaceThing 函数的作用域。因此，unused 函数符合闭包的定义。")])]),t._v(" "),n("h3",{attrs:{id:"c-事件重复监听"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#c-事件重复监听"}},[t._v("#")]),t._v(" c.事件重复监听")]),t._v(" "),n("p",[t._v("这种情况很容易在复用对象上添加事件时出现。")]),t._v(" "),n("p",[t._v("node.js中HTTP keepalive模式是开启的，当客户端和服务器之间的 TCP 连接保持打开状态时，Node.js 进程会一直保持该连接的内部状态，直到连接关闭或超时。如果您的应用程序使用了 HTTP keep-alive 并且在处理请求时没有正确释放内存，那么在长时间运行的情况下，这些未释放的内存可能会逐渐增加，最终导致内存泄漏。")]),t._v(" "),n("p",[t._v("解决：")]),t._v(" "),n("blockquote",[n("ol",[n("li",[t._v("使用 Node.js 内置的 http.Agent 类来控制 HTTP keep-alive 的行为，可以设置 maxSockets 参数限制在特定时间内打开的 TCP 连接的最大数量。")])])]),t._v(" "),n("ol",{attrs:{start:"2"}},[n("li",[t._v("通过减少每个 TCP 连接上的 HTTP 请求的数量或缩短 HTTP 请求之间的时间间隔来限制 HTTP keep-alive 的使用。")])]),t._v(" "),n("h3",{attrs:{id:"d-缓存爆炸"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#d-缓存爆炸"}},[t._v("#")]),t._v(" d.缓存爆炸")]),t._v(" "),n("p",[t._v("使用内存（Object/Map）做缓存是我们开发中常见的方式。如果不注意控制缓存大小和过期时间，可能会造成失效的数据仍然在内存中，导致缓存溢出。")]),t._v(" "),n("p",[t._v("缓存中存储的键越多，长期存活的对象就越多。")]),t._v(" "),n("p",[t._v("举例：")]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" cache "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setCache")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  cache"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Date"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Array")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setInterval")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("setCache"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("上例中，一直添加缓存，不进行清理，会导致缓存撑爆。")]),t._v(" "),n("p",[t._v("解决：使用"),n("a",{attrs:{href:"https://www.npmjs.com/package/lru-cache",target:"_blank",rel:"noopener noreferrer"}},[t._v("lru-cache"),n("OutboundLink")],1),t._v("组件，通过LRU淘汰算法来避免缓存爆炸。")]),t._v(" "),n("h3",{attrs:{id:"内存泄露监控及定位解决"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#内存泄露监控及定位解决"}},[t._v("#")]),t._v(" 内存泄露监控及定位解决")]),t._v(" "),n("h4",{attrs:{id:"heapdump-chrome-devtool-定位解决"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#heapdump-chrome-devtool-定位解决"}},[t._v("#")]),t._v(" heapdump + Chrome Devtool 定位解决")]),t._v(" "),n("p",[n("code",[t._v("heapdump")]),t._v("在运行初期生成一个初始内存快照文件，运行一段时间后（发生了内存泄露后）再生成一个内存快照")]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[t._v("heapdump"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("writeSnapshot")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'init.heapsnapshot'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n\nheapdump"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("writeSnapshot")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'leak.heapsnapshot'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("将两个快照导"),n("code",[t._v("Chrome 入Devtool")]),t._v("的"),n("code",[t._v("Memory")]),t._v("面板进行分析。"),n("code",[t._v("Delta")]),t._v("标识变化的数量，"),n("code",[t._v("Size Delta")]),t._v("表示变化空间的大小。")]),t._v(" "),n("p",[t._v("通过内存快照找到数量不断增加的对象，找到增加对象是被谁给引用。")]),t._v(" "),n("h4",{attrs:{id:"pm2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#pm2"}},[t._v("#")]),t._v(" pm2")]),t._v(" "),n("p",[t._v("生产环境中可以使用pm2守护进程。")]),t._v(" "),n("p",[t._v("设置内存消耗达到限制时的重启机制：")]),t._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[t._v("pm2 start index.js --max-memory-restart 8G\n")])])]),n("p",[t._v("可以同时通过负载均衡器实现多个节点来避免服务中断。")]),t._v(" "),n("h4",{attrs:{id:"node-memwatch"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#node-memwatch"}},[t._v("#")]),t._v(" node-memwatch")]),t._v(" "),n("p",[t._v("原生模块，当它检测到正在运行的代码中存在内存泄漏时，会触发一个事件。")]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" memwatch "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"memwatch"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nmemwatch"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("on")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"leak"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("info")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// event emitted")]),t._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("info"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("reason"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("该事件通过 leak 发布，其回调对象有一个 reason 属性，会表示经过连续的垃圾回收后，堆内存占用逐渐增长。")]),t._v(" "),n("h3",{attrs:{id:"如何避免内存泄露"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#如何避免内存泄露"}},[t._v("#")]),t._v(" 如何避免内存泄露")]),t._v(" "),n("ol",[n("li",[t._v("Lint工具检测代码检查非期望的全局变量。")]),t._v(" "),n("li",[t._v("使用闭包的时候，得知道闭包了什么对象，还有引用闭包的对象何时清除闭包。最好可以避免写出复杂的闭包，因为复杂的闭包引起的内存泄漏，如果没有打印内存快照的话，是很难看出来的。")]),t._v(" "),n("li",[t._v("绑定事件的时候，一定得在恰当的时候清除事件。在编写一个类的时候，推荐使用 init 函数对类的事件监听进行绑定和资源申请，然后 destroy 函数对事件和占用资源进行释放。")])]),t._v(" "),n("h2",{attrs:{id:"参考"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),n("p",[t._v("https://deepu.tech/memory-management-in-v8/")]),t._v(" "),n("p",[t._v("https://blog.risingstack.com/node-js-at-scale-node-js-garbage-collection/")]),t._v(" "),n("p",[t._v("https://zhuanlan.zhihu.com/p/25736931")]),t._v(" "),n("p",[n("a",{attrs:{href:"https://mp.weixin.qq.com/s?src=11&timestamp=1683795973&ver=4522&signature=d-OehWXD7QiHeOVTuLufnv-hmHPT6cmsl32-L3c7b3GLWc6t73wXwnyD3Sf8lQYq6fBAt8LNEWDwvliQ8XbP4pImrdWhXsvokLWEU95GgP12ZZHgANm8UZaj7u1bwPDf&new=1",target:"_blank",rel:"noopener noreferrer"}},[t._v("为什么 Node 应用要用 PM2 来跑？"),n("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=e.exports}}]);